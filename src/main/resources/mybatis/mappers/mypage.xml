<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.mypage">
	<!-- 리절트 맵 정의 -->
	<!-- 결제내역 조회 -->
	<resultMap id="orderProductResult" type="orderVO">
		<result property="order_seq_num" column="order_seq_num" />
		<result property="order_id" column="order_id" />
		<result property="member_id" column="member_id" />
		<result property="product_id" column="product_id" />
		<result property="orderer_name" column="orderer_name" />
		<result property="orderer_hp1" column="orderer_hp1" />
		<result property="orderer_hp2" column="orderer_hp2" />
		<result property="orderer_hp3" column="orderer_hp3" />
		<result property="nonmember_pw" column="nonmember_pw" />
		<result property="center_name" column="center_name" />
		<result property="product_name" column="product_name" />
		<result property="product_main_image"
			column="product_main_image" />
		<result property="product_price" column="product_price" />
		<result property="product_sales_price"
			column="product_sales_price" />
		<result property="goods_filename" column="goods_filename" />
		<result property="receiver_name" column="receiver_name" />
		<result property="receiver_hp1" column="receiver_hp1" />
		<result property="receiver_hp2" column="receiver_hp2" />
		<result property="receiver_hp3" column="receiver_hp3" />
		<result property="pay_method" column="pay_method" />
		<result property="card_com_name" column="card_com_name" />
		<result property="card_pay_month" column="card_pay_month" />
		<result property="pay_order_time" column="pay_order_time" />
		<result property="order_state" column="order_state" />
		<result property="option_id" column="option_id" />
		<result property="option_name" column="option_name" />
	</resultMap>

	<!-- 환불/취소 신청 -->
	<resultMap id="refundResult" type="refundVO">
		<result property="refund_id" column="refund_id" />
		<result property="order_seq_num" column="order_seq_num" />
		<result property="refund_price" column="refund_price" />
		<result property="order_state" column="order_state" />
		<result property="account_holder" column="account_holder" />
		<result property="account_bank" column="account_bank" />
		<result property="account_number" column="account_number" />
		<result property="cancel_reason" column="cancel_reason" />
	</resultMap>
	
	<!-- 적립금 조회 -->
	<resultMap id="pointResult" type="pointVO">
		<result property="point_id" column="point_id" />
		<result property="point_state" column="point_state" />
		<result property="point_name" column="point_name" />
		<result property="point_price" column="point_price" />
		<result property="point_date" column="point_date" />
		<result property="member_id" column="member_id" />
		<result property="product_id" column="product_id" />
	</resultMap>

	<!-- 회원정보 수정 -->
	<resultMap id="memberResult" type="MemberVO">
		<result property="member_id" column="member_id" />
		<result property="member_pw" column="member_pw" />
		<result property="member_name" column="member_name" />
		<result property="member_gender" column="member_gender" />
		<result property="member_rrn1" column="member_rrn1" />
		<result property="member_rrn2" column="member_rrn2" />

		<result property="member_birth_y" column="member_birth_y" />
		<result property="member_birth_m" column="member_birth_m" />
		<result property="member_birth_d" column="member_birth_d" />

		<result property="hp1" column="hp1" />
		<result property="hp2" column="hp2" />
		<result property="hp3" column="hp3" />
		<result property="smssts_yn" column="smssts_yn" />
		<result property="email1" column="email1" />
		<result property="email2" column="email2" />
		<result property="emailsts_yn" column="emailsts_yn" />

		<result property="zipcode" column="zipcode" />
		<result property="road_address" column="road_address" />
		<result property="jibun_address" column="jibun_address" />
		<result property="namuji_address" column="namuji_address" />
		<result property="join_date" column="join_date" />
		<result property="join_type" column="join_type" />

		<result property="center_name" column="center_name" />
		<result property="owner_eid" column="owner_eid" />
		<result property="owner_tel1" column="owner_tel1" />
		<result property="owner_tel2" column="owner_tel2" />
		<result property="owner_tel3" column="owner_tel3" />
	</resultMap>

	<!-- 회원정보에 따른 대표 주문정보 조회 -->
	<select id="selectMyOrderList" resultMap="orderProductResult"
		parameterType="java.util.Map">
       <![CDATA[
         select *
            FROM (
            SELECT 
            ROW_NUMBER() over(order by order_seq_num) AS rowNum,
            SUM(a.product_option_price+a.product_sales_price) AS total_price,
                a.order_seq_num,
                a.member_id,
               a.pay_order_time,
              a.order_state,
               a.order_id,
              a.product_name,
              a.product_sales_price,
              a.product_price,
              a.product_option_name,
              a.product_option_price,
                 b.product_id,
                 b.product_main_image
                from t_order a, t_product b
                 WHERE a.product_id = b.product_id
             GROUP BY a.order_id
             )a
          where rowNum BETWEEN (#{maxnum}-4) - (#{chapter}-1)*5 and (#{maxnum}) - (#{chapter}-1)*5
          and member_id=#{member_id}
             order by order_seq_num DESC
      ]]>
	</select>

	<!-- 회원정보에 따른 주문정보 전체 조회 -->
	<select id="selectOrderMember" resultMap="orderProductResult"
		parameterType="java.util.Map">
       <![CDATA[
         SELECT *
      FROM (
            SELECT
                a.order_seq_num,
                a.member_id,
               a.pay_order_time,
              a.order_state,
               a.order_id,
              a.product_name,
              a.product_sales_price,
              a.product_price,
              a.product_option_name,
              a.product_option_price,
                 b.product_id,
                 b.product_main_image
                from t_order a, t_product b
                 WHERE a.product_id = b.product_id
            )a
            WHERE member_id=#{member_id}
      ]]>
	</select>

	<!-- 페이지네이션 -->
	<select id="maxNumSelect" resultType="String"
		parameterType="java.util.Map">
       <![CDATA[
             SELECT COUNT(*)
         FROM(
            SELECT 
               a.order_seq_num,
              b.product_main_image
                from t_order a, t_product b
                 WHERE a.product_id = b.product_id
             GROUP BY a.order_id
             )a
      ]]>
	</select>

	<!-- 주문 회원 목록 조회 -->
	<select id="orderMemberListSelect" resultType="String"
		parameterType="java.util.Map">
       <![CDATA[
             SELECT COUNT(*)
			 from t_order
			 WHERE member_id=#{member_id}
			 GROUP BY order_id
			 ORDER BY order_seq_num DESC
      ]]>
	</select>

	<!-- 주문 상세보기 페이지 -->
	<select id="selectMyOrderDetail" resultMap="orderProductResult"
		parameterType="String">
       <![CDATA[
         select a.*, b.product_id, b.product_main_image, SUM(a.product_sales_price+a.product_option_price) over (PARTITION BY order_id) AS total_price
         from t_order a, t_product b
            where a.order_id=#{order_id} and a.product_id = b.product_id
            order by order_seq_num desc
      ]]>
	</select>

	<!-- 주문취소 페이지 -->
	<select id="selectMyOrderCancel" resultMap="orderProductResult"
		parameterType="java.util.Map">
       <![CDATA[
         select a.*, b.product_id, b.product_main_image, SUM(a.product_sales_price+a.product_option_price) over (PARTITION BY order_id) AS refund_price
         from t_order a, t_product b
         where a.product_id = b.product_id 
            and order_seq_num in
      ]]>
		<foreach item="item" collection="list" open="(" separator=","
			close=")">
			#{item}
		</foreach>
		order by order_seq_num desc
	</select>
	
	<!-- 환불 정보 입력 -->
	<insert id="refundMyOrder" parameterType="java.util.Map">
   <![CDATA[
      insert into t_refund(refund_id,
      				 order_seq_num,
                     refund_price,
                     order_state,
                     account_holder,
                     account_bank,
                     account_number,
                     cancel_reason)
                values(#{refund_id},
                	  #{order_seq_num},
                      #{refund_price},
                      #{order_state},
                      #{account_holder},
                      #{account_bank},
                      #{account_number},
                      #{cancel_reason})
   ]]>
	</insert>

	<!-- 환불 시 결제 상태 업데이트 -->
	<update id="updateOrderState" parameterType="java.util.Map">
    <![CDATA[
            update t_order
            set order_state=#{order_state} 
            where order_seq_num=#{order_seq_num}
         ]]>
	</update>
	
	<!-- 환불번호 부여 -->
	<select id="selectNewRefundId" resultType="int">
		<![CDATA[
			select ifnull(max(refund_id), 0) + 1 from t_refund
		]]>
	</select>



	<!-- 적립금 총 내역 -->
	<select id="selectMyStackList" resultType="pointVO" parameterType="java.util.Map">
       <![CDATA[
            SELECT *
			FROM(SELECT *, ROW_NUMBER() over(order by point_id) AS rowNum
				FROM t_point
				WHERE member_id=#{member_id})a
			where rowNum BETWEEN (#{maxnum}-4) - (#{chapter}-1)*5 and (#{maxnum}) - (#{chapter}-1)*5
			ORDER BY point_id desc
      	]]>
	</select>

	<!-- 적립금 총 개수 -->
	<select id="maxStackSelect" resultType="String" parameterType="java.util.Map">
       <![CDATA[
             SELECT COUNT(*)
             from t_point
             WHERE member_id = #{member_id}
             order BY point_id desc
      ]]>
	</select>

	<!-- 현재 적립금 -->
	<select id="nowPointSelect" resultType="String" parameterType="String">
       <![CDATA[
            SELECT (SELECT SUM(case when point_state='적립' then point_price ELSE 0 END))- (SELECT SUM(case when point_state='이용' then point_price ELSE 0 END)) AS now
			FROM t_point
			WHERE member_id=#{member_id}
			ORDER BY point_id desc
      ]]>
	</select>

	<!-- 마이페이지 계정 비밀번호 확인 -->
	<select id="myPageDetail" resultType="memberVO"
		parameterType="java.util.Map">
       <![CDATA[
         select * from t_member 
          where member_id=#{member_id}
          and member_pw=#{member_pw}
      ]]>
	</select>

	<!-- 회원정보 수정 -->
	<update id="updateMyInfo" parameterType="java.util.Map">
		update t_member
		<set>
			<if test=" member_pw!='' and member_pw!=null">
				member_pw=#{member_pw},
			</if>
			<if test=" zipcode!='' and zipcode!=null">
				zipcode=#{zipcode},
			</if>
			<if test=" road_address!='' and road_address!=null">
				road_address=#{road_address},
			</if>
			<if test=" jibun_address!='' and jibun_address!=null">
				jibun_address=#{jibun_address},
			</if>
			<if test=" namuji_address!='' and namuji_address!=null">
				namuji_address=#{namuji_address},
			</if>
			<if test=" hp1!='' and hp1!=null">
				hp1=#{hp1},
			</if>
			<if test=" hp2!='' and hp2!=null">
				hp2=#{hp2},
			</if>
			<if test=" hp3!='' and hp3!=null">
				hp3=#{hp3},
			</if>
			<if test=" smssts_yn!='' and smssts_yn!=null">
				smssts_yn=#{smssts_yn},
			</if>
			<if test=" email1!='' and email1!=null">
				email1=#{email1},
			</if>
			<if test=" email2!='' and email2!=null">
				email2=#{email2},
			</if>
			<if test=" emailsts_yn!='' and emailsts_yn!=null">
				emailsts_yn=#{emailsts_yn},
			</if>
			<if test=" member_birth_y!='' and member_birth_y!=null">
				member_birth_y=#{member_birth_y},
			</if>
			<if test=" member_birth_m!='' and member_birth_m!=null">
				member_birth_m=#{member_birth_m},
			</if>
			<if test=" member_birth_d!='' and member_birth_d!=null">
				member_birth_d=#{member_birth_d},
			</if>
		</set>
		where
		member_id=#{member_id}
	</update>
	
	<!-- 회원탈퇴 -->
	<delete id="deleteMember" parameterType="java.util.Map">
      <![CDATA[
         delete from t_member
         where member_id=#{member_id} and member_pw=#{member_pw}
        ]]>
	</delete>

</mapper>